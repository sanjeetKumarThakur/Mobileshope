var mongoose = require("mongoose");

const getMongoUrl = (data) => {
  if (data.authSource === null || data.authSource === undefined) {
    data.authSource = data.mongodb_database;
  }
  if (data.mongodb_ssl === "true") {
    return (
      "mongodb://" +
      data.mongodb_user +
      ":" +
      data.mongodb_pass +
      "@" +
      data.mongodb_ip +
      "/" +
      data.mongodb_database +
      `?authSource=${data.authSource}&ssl=true&sslValidate=false&retryWrites=false&replicaSet=rs0`
    );
  } else {
    return data.mongodb_user && data.mongodb_pass
      ? `mongodb://${data.mongodb_user}:${data.mongodb_pass}@${data.mongodb_ip}/${data.mongodb_database}?authSource=${data.authSource}`
      : "mongodb://" + data.mongodb_ip + "/" + data.mongodb_database;
  }
};

const getMongoConnection = (data) => {
  const db = mongoose.createConnection(getMongoUrl(data), getMongoOptions());
  return db;
};

const getMongoOptions = () => {
  return {
    useNewUrlParser: true,
    useUnifiedTopology: true,
  };
};

module.exports = {
  getMongoUrl,
  getMongoConnection,
  getMongoOptions,
};
